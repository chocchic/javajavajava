# Node_MySQL 연동  
## 1. 기본 요청이 왔을 때 html 출력  
### 1) index.js파일에 기본 요청을 처리하는 라우팅 코드를 출력  
  ```javascript  
  //기본 요청이 왔을 때 수행할 내용
    app.get('/', (req, res, next) => {
        res.sendFile(path.join(__dirname,'index.html'))
    })
  ```  

### 2) public 디렉토리에 index.html파일을 생성해서 작성  
  ```html
  <!DOCTYPE html>
  <html>
      <head>
          <meta charset="utf-8"/>
          <title>Node_MySQL</title>
      </head>
      <body>
          <h1>MySQL</h1>
      </body>
  </html>
  ```  

### 3) 서버를 구동하고 localhost:포트번호를 입력하고 index.html파일이 출력되는지 확인  

### 4) 프로젝트의 log 디렉토리의 오늘 날짜 로그파일이 생성되고 로그가 기록되는지 확인  

  * 동기(Sync, 프로세스, 절차적)와 비동기(Async, 스레드, 비절차적-객체지향, 콜백)  
    동기적 처리는 위에서부터 아래로 순차적으로 실행

    비동기적처리는 작업 수행도중 쉬는 시간이 발생하거나 cpu를 사용하지 않ㄴ아도 되는 작업이 발생하면 다른 작업을 수행할 수 있도록 제어권을 넘길 수 있는 처리  
    상속 Inhertance - 상속받아서 작업(SubClassing)  
    async : 비동기적 처리  
    await : async가 끝나고나면 해주세요  

  * 객체 지향
    ```java
      class Temp{
        // private int a;
        public int getA(){
          return a;
        }
        private int a; // 실질적으로 a가 만들어지는 것은 Temp의 생성자이므로 어디에서 선언하든 상관 없음
        // 생성자는 allocation과 init을 하기 때문
      }
    ```
  * Hoising : 이름을 만들기 전에 사용할 수 있도록 하는 것  
    javascript에서는 var가 hoisting가능, let으로 만들면 hosting이 안됨  
    ```javascript
    function getA(){
      return a; // 에러
    }
    console.log(getA());
    let a;
    ```  


## 2.전체 데이터 가져와서 출력하기
### 1)app.js 파일에서 모든 데이터를 가져와서 리턴해주는 요청을 처리하는 라우팅 함수를 구현
  ```javascript
  // 전체 데이터 가져오기 요청을 처리하는 라우팅 함수
  app.get('/item/all', (req,res, next)=>{
      // 전체 데이터와 전체 데이터 개수를 가져와서 출력
      var list = [] // 조회한 데이터 저장할 배열
      var count = 0; // 조회한 데이터 개수를 저장할 변수

      // 전체 데이터 가져오는 query
      connection.query('select * from goods order by itemid desc', (err, results,fields)=>{
          //에러가 발생했을 때
          if(err){
              throw err;
          }
          list = results;
          //데이터 개수 가져오기
          connection.query('select count(*) cnt from goods', (err, results, fields)=>{
              //에러가 발생했을 때
              if(err){
                  throw err;
              }

              //읽어온 데이터 개수를 count에 저장
              count = results[0].cnt;
              //json출력
              res.json({'count': count, 'list':list})
          })
      })
  })
  ```  

### 2) 웹 브라우저에서 localhost:포트번호/item/all을 입력하고 데이터가 출력되는지 확인  
  * 구조는 count키에 데이터 개수가 저장되어 있고 list키에 item 배열이 저장되어 있습니다.  

### 3) index.html 파일에 요청 메뉴와 출력영역을 작성  
  ```html
   <!-- 메뉴 -->
        <a href="#" id="allbtn">전체데이터 가져오기</a>
        <!-- 데이터 출력 영역-->
        <div id="content"></div>
        <!-- 데이터 삽입과 수정시 폼을 출력할 영역-->
        <div id="updatearea"></div>
  ```

  * head에 script 작성시 유의할 점  
    HTML, CSS, JavaScript를 가지고 HTML파일을 생성해서 출력하는데, HTML 태그와 JavaScript코드는 작성한 순서대로 동작. CSS는 HTMl 태그 부분을 전부 랜더링하고 수행.  

    ```html
      <html>
        <head>
            <style>
              #content{color:red;}
            </style>
            <script>
              document.getElementById('content').innerHTML ="HI"; // HI로 바뀌지 않음
              window.addEventListener('load', (e)=>{
                document.getElementByID('content').innerHTML = "HI"; // 바뀜
              }) 
            </script>
        </head>
        <body>
            <div id="content">Hello</div>
        </body>
        <script>
          document.getElementByID('content').innerHTML = "HI"; // 아래에 작성했으므로 window~이 과정을 수행할 필요가 없음. html 태그가 다 로딩되고 수행되기 떄문
        </script>
      </html>
    ```
### 4) index.html 파일에 전체 데이터 가져오기 메뉴를 클릭했을 수행되는 동작을 위한 스크립트 코드 작성
  ```javascript
  <script>
      var content = document.getElementById('content')
      var updatearea = document.getElementById('updatearea')
      // 전체 데이터 가져오기를 클릭했을 때
      document.getElementById('allbtn').addEventListener('click',(e)=>{
          // ajax 객체 생성
          var request = new XMLHttpRequest();
          // 요청 생성
          request.open('GET', '/item/all', true);
          // 요청 전송
          request.send('');
          // 응답을 받았을 때
          request.addEventListener('load', ()=>{
              //json형식으로 넘어오는지 확인
              //alert(request.responseText); 

              // json으로 받게 해놔서 responseText 사용 xml이면 객체임
              // 읽어온 테이터 파싱
              var data  = JSON.parse(request.responseText);
              // count에는 데이터 개수가 list에는 데이터배열
              var count = data.count;
              var list = data.list;

              // 출력 내용 만들기
              var display = "<div align='center' class='body'><h2>상품목록 화면</h2>";
              display += "<table border='1'><tr><td colspan='3' align='right'> 전체 데이터 개수 : "+count+"</td></tr>";
              display += "<tr class='header'><th align='center' width='80'>상품ID</th>";
              display += "<th align='center' width='320'>상품이름</th>";
              display += "<th align='center' width='100'>가격</th></tr>";

              // 데이터 출력
              for(var idx in list){
                  var item = list[idx];
                  // 하나의 행을 만들어서 출력
                  display +="<tr class='record'><td align='center'>" + item.itemid +"</td>";
                  display +="<td align='left'>"+item.itemname+"</td>";
                  display +="<td align='right'>"+item.price+"원</td></tr>";
              }
              display += "</table></div>";

              content.innerHTML = display;
          })
      })
  </script>
  ```
### 5) index.html 파일에 스타일시트 링크를 추가
  ```html
  <link rel="stylesheet" href="/css/common.css"/>
  ```

### 6) public 디렉토리에 css 디렉토리를 만들고 common.css를 추가한 후 작성
 ```css
  a{
      text-decoration: none;
  }
  div.body{
      margin-top:50px;
      margin-bottom:50px;
  }
  tr.header{
      background: #C9BFED;
  }

  tr.record{
      background: #EDEDED;
  }
  ```

## 3. 데이터의 일부분 출력  
### 1)index.js 파일에 데이터 일부분만 가져와서 리턴하는 라우팅 함수 작성
    ```javascript
    // 데이터 일부분 가져오기
    app.get('/item/list', (req, res,next) =>{
        // 파라미터 가져오기 : 일부분 가져오는 경우는 데이터개수와 페이지 번호
        // get 방식에서 pageno와 count 파라미터 가져오기
        const pageno = req.query.pageno;
        const count = req.query.count;

        // 일부분 가져오기 위한 변수를 선언
        var start = 0;
        var size = 5;

        if(count != undefined){
            size = parseInt(count);
        }
        if(pageno != undefined){
            start = (parseInt(pageno) -1) *size;
        }

        var list = [];
        connection.query('select * from goods order by itemid limit ?, ?', [start, size], (err,results, fields) =>{
            list = results;

            connection.query('select count(*) cnt from goods', (err, results, fields) =>{
                res.json({'count':results[0].cnt, 'list':list})
            })
        })
    })
    ```  
### 2) 브라우저에 아래 URL을 입력해서 나오는 데이터 확인  
  http://localhost:9000/item/list - 첫번째 데이터 5개  
  http://localhost:9000/item/list?pageno=2 - 두번째 페이지 데이터 5개  
  http://localhost:9000/item/list?pageno=2&count=10 - 두번째 페이지 데이터 10개  

### 3) index.html 파일에 일부분 가져오기 메뉴 생성  
  ```html
  <a href="#" id="listbtn">처음 5개의 데이터 가져오기</a>
  ```

### 4)index.html 파일에 listbtn 을 클릭했을 때 수행할 스크립트 코드 추가
  ```javascript
  //데이터 일부분 가져오기
  var pageno = 1;
  var count = 5;

  document.getElementById("listbtn").addEventListener(
  'click',(e) => {

  pageno = 1;
  count = 5;

  var request = new XMLHttpRequest();
  request.open("GET", "/item/list?" + 'pageno=' + pageno + 
      "&count=" + count);
  request.send('');

  updatearea.innerHTML = "";
  request.addEventListener('load', function(){
      //데이터 가져오기
      var data = JSON.parse(request.responseText)
      var list = data.list;
      var cnt = data.count;

      //출력 내용 만들기
      var display = "<div align='center' class='body'>";
      display += "<h2>상품 목록 화면</h2>";    
          
      display += "<table border='1' id='tbldata'>";
          
      display += "<tr><td colspan='3' align='right'>";
      display += "전체 데이터 개수:" + cnt;
      display += "</td></tr>";

      display += "<tr class='header'>";
      display += "<th align='center' width='80'>";
      display += "상품ID</th>"; 
      display += "<th align='center' width='320'>";
      display += "상품이름</th>"; 
      display += "<th align='center' width='100'>";
      display += "가격</th></tr>";  

      for(var idx in list){
          var item = list[idx];

          //하나의 행을 만들어서 출력
          display += "<tr class='record'>";
          display += "<td align='center'>" + item.itemid;
          display += "</td>";
          display += "<td align='left'>" + item.itemname;
          display += "</td>";
          display += "<td align='right'>" + item.price;
          display += "원</td></tr>";
      }
      display += "</table>";
      display += "</div>";
      content.innerHTML = display;

      //다음 페이지의 데이터를 가져와서 추가할 UI를 추가
      display = "";
      if((pageno-1) * count < cnt){
          display += "<table align='center' "; 
          display += " width='500' id='tblbtn'>";
          display += "<tr><td align='center' colspan='3'>";
          display += "<span id='addbtn'>더보기</span></td>";
          display += "</tr></table>";
      }
      content.innerHTML += display;

    })

  })
  ```



